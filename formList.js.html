<script>
  $(function () {
    // ===========================================================================
    // Page Loader
    // ===========================================================================
    const loaderHTML = `
    <div id="page-loader" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #ffffff; 
      z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center;
      transition: opacity 0.5s ease, visibility 0.5s ease;">
      <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
      <p class="mt-3" style="color: #64748b; font-family: 'SF Pro Text', 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, sans-serif;">
        Loading Form Controller...
      </p>
    </div>
  `;

    $('body').prepend(loaderHTML);

    function hideLoader() {
      $('#page-loader').css({
        'opacity': 0,
        'visibility': 'hidden'
      });

      setTimeout(() => {
        $('#page-loader').remove();
      }, 500);
    }

    $(window).on('load', function () {
      if ($('#image').prop('complete')) {
        setTimeout(hideLoader, 500);
      }
    });

    $(document).on('imageLoaded', function () {
      setTimeout(hideLoader, 300);
    });

    setTimeout(hideLoader, 5000);

    // ===========================================================================
    // Core Initialization
    // ===========================================================================
    const formDetailsModal = new bootstrap.Modal($('#formDetailsModal')[0]);
    let currentControlNumber = null;
    let currentTemplateData = null;
    let isSubmitting = false;
    const isMobile = 768;

    initializeNavigation();
    setTimeout(() => $('#searchInput').focus(), 300);
    loadFormData();

    // ===========================================================================
    // Navigation Functions
    // ===========================================================================
    function initializeNavigation() {
      $('.nav-link').on('click', function (e) {
        e.preventDefault();
        const targetPageId = $(this).data('page');

        $('.nav-link').removeClass('active');
        $(this).addClass('active');

        $('.page').removeClass('active');
        $('#' + targetPageId).addClass('active');

        if (targetPageId === 'search-page') {
          setTimeout(() => $('#searchInput').focus(), 100);
        }

        if (targetPageId === 'submissions-page') {
          loadSubmissionsData();
        }
      });
    }

    // ===========================================================================
    // Personnel Levels Management
    // ===========================================================================
    function loadPersonnelData() {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function (response) {
            if (response.status === "success" && response.names) {
              window.personnelData = response;
              resolve(response);
            } else {
              reject(new Error('Failed to load personnel data'));
            }
          })
          .withFailureHandler(function (error) {
            console.error('Failed to load personalities:', error);
            reject(error);
          })
          .getPersonalities();
      });
    }

    // Store all unique levels
    const allLevels = [
      "Director", "Chief", "Asst. Chief", "Accountant",
      "Budget Officer", "Division Chief", "Commisioner",
      "Retired", "Chief Technical", "Chief Administrative"
    ];
    window.selectedLevels = [];

    function setupPersonnelLevelsSection() {
      // Clear existing content
      $('#levelSelector').empty();
      $('#levelOrderContainer').empty();

      // Default options
      $('#levelSelector').append('<option value="" disabled selected>Add Level</option>');

      // Get personnel with levels from data
      const personnelWithLevels = window.personnelData.names
        .map(name => {
          let level = '';
          if (window.personnelData.values) {
            const personnelEntry = window.personnelData.values.find(p => p[1] === name);
            if (personnelEntry && personnelEntry.length > 4) {
              level = personnelEntry[4] || '';
            }
          }
          return { name, level };
        })
        .filter(person => person.level);

      if (!personnelWithLevels || personnelWithLevels.length === 0) {
        $('#levelSelector').append('<option value="" disabled>No levels available</option>');
        showAlert('No personnel with level assignments available', 'warning');
        return;
      }

      // Populate level selector with predefined levels only, without email counts
      allLevels.forEach(level => {
        $('#levelSelector').append(`<option value="${level}">${level}</option>`);
      });

      // Initialize empty selected levels array and hidden input
      window.selectedLevels = [];
      updateLevelOrderInput();

      // Add button click event
      $('#addLevelBtn').off('click').on('click', function () {
        addLevelToOrder();
      });
    }

    function addLevelToOrder() {
      const level = $('#levelSelector').val();

      if (!level) {
        showAlert('Please select a level to add', 'warning');
        return;
      }

      // Add to array if not already present
      if (!window.selectedLevels.includes(level)) {
        window.selectedLevels.push(level);

        // Calculate the step number (Author is step 1, so levels start at 2)
        const stepNumber = window.selectedLevels.length + 1;

        // Special note for Division Chief
        let specialNote = '';
        if (level === 'Division Chief') {
          specialNote = `<small class="text-info d-block mt-1"><i class="bi bi-info-circle me-1"></i>The appropriate Division Chief will be automatically assigned based on your division.</small>`;
        }

        // Create a new approval step without email notes
        const approvalStep = $(`
          <div class="approval-step" data-level="${level}" data-order="${window.selectedLevels.length}">
            <div class="approval-step-number">${stepNumber}</div>
            <div class="approval-step-content">
              <div class="approval-step-title">${level}</div>
              <div class="approval-step-desc">Approval level ${window.selectedLevels.length}${specialNote}</div>
            </div>
            <button type="button" class="approval-step-remove">
              <i class="bi bi-x"></i>
            </button>
          </div>
        `);

        // Add connector if it's not the first item
        if (window.selectedLevels.length > 1) {
          const connector = $(`
            <div class="approval-connector">
              <i class="bi bi-arrow-down"></i>
            </div>
          `);
          $('#levelOrderContainer').append(connector);
        }

        // Remove empty state if present
        $('.approval-empty-state').remove();

        // Add to container
        $('#levelOrderContainer').append(approvalStep);

        // Add remove event
        approvalStep.find('.approval-step-remove').on('click', function () {
          const levelToRemove = approvalStep.data('level');
          removeLevelFromOrder(levelToRemove);

          // Remove the connector above this step if it exists
          const prevConnector = approvalStep.prev('.approval-connector');
          if (prevConnector.length) {
            prevConnector.remove();
          } else {
            // If no connector above, remove the connector below if it exists and this is the first item
            const nextConnector = approvalStep.next('.approval-connector');
            if (nextConnector.length && approvalStep.data('order') === 0) {
              nextConnector.remove();
            }
          }

          approvalStep.remove();

          // Add empty state if no levels
          if (window.selectedLevels.length === 0) {
            $('#levelOrderContainer').html(`
              <div class="approval-empty-state text-center p-3">
                <i class="bi bi-diagram-3 text-muted mb-2" style="font-size: 2rem;"></i>
                <p class="text-muted mb-0">No approval levels added yet. Use the "Add Level" button to create your approval workflow.</p>
              </div>
            `);
          } else {
            // Reorder remaining steps
            reorderApprovalSteps();
          }
        });

        // Update hidden input
        updateLevelOrderInput();
      } else {
        showAlert(`${level} is already in the approval workflow`, 'info');
      }

      // Reset selector
      $('#levelSelector').val('');
    }

    function removeLevelFromOrder(level) {
      // Remove from array
      window.selectedLevels = window.selectedLevels.filter(l => l !== level);
      updateLevelOrderInput();
    }

    function reorderApprovalSteps() {
      // Check if author is included
      const isAuthorIncluded = $('#authorToggle').is(':checked');
      const authorOffset = isAuthorIncluded ? 1 : 0; // If author is included, dynamic levels start at step 2, otherwise at step 1

      // Refresh all step numbers and descriptions
      $('.approval-step:not(.fixed)').each(function (index) {
        const stepNumber = index + 1 + authorOffset; // Add authorOffset to adjust numbering
        const stepOrder = index;
        const level = $(this).data('level');

        // Update the step number
        $(this).data('order', stepOrder);
        $(this).find('.approval-step-number').text(stepNumber);

        // Special note for Division Chief
        let specialNote = '';
        if (level === 'Division Chief') {
          specialNote = `<small class="text-info d-block mt-1"><i class="bi bi-info-circle me-1"></i>The appropriate Division Chief will be automatically assigned based on your division.</small>`;
        }

        // Update description with special note if needed
        $(this).find('.approval-step-desc').html(`Approval level ${index + 1}${specialNote}`);
      });
    }

    function updateLevelOrderInput() {
      $('#levelOrderArray').val(window.selectedLevels.join(','));
    }

    function getLevelOrder() {
      return window.selectedLevels.join(',');
    }

    // ===========================================================================
    // Form Details Modal
    // ===========================================================================
    $('#formDetailsModal').on('shown.bs.modal', function () {
      setTimeout(enhanceFormFields, 100);

      $('#refreshPreviewBtn').off('click').on('click', function () {
        updateDocumentPreview();
        const btn = $(this);
        const originalText = btn.html();
        btn.html('<i class="bi bi-check-lg me-2"></i>Updated');
        btn.addClass('btn-success');

        setTimeout(() => {
          btn.html(originalText);
          btn.removeClass('btn-success');
        }, 1500);
      });

      // Set up personnel initials section
      loadPersonnelData().then(() => {
        setupPersonnelLevelsSection();
        setupAuthorToggle();
        setupControlNumberToggle();
      }).catch(err => {
        showAlert('Failed to load personnel data: ' + err.message, 'danger');
      });
    });

    $('#formDetailsModal').on('hidden.bs.modal', function () {
      // Simply reset variables, don't call any server-side functions
      currentControlNumber = null;
      currentTemplateData = null;
      isSubmitting = false;
    });

    function enhanceFormFields() {
      $('#formFieldsContainer').find('label').addClass('form-label');
      $('#formFieldsContainer').find('input:not([readonly]), select, textarea').addClass('form-control mb-2');
      $('#formFieldsContainer .form-group, #formFieldsContainer .mb-3').addClass('mb-3');

      $('#formFieldsContainer .mb-3').each(function (index) {
        $(this).css({
          'opacity': '0',
          'transform': 'translateY(10px)',
          'transition': 'all 0.3s ease',
          'transition-delay': (index * 0.05) + 's'
        });

        setTimeout(() => {
          $(this).css({
            'opacity': '1',
            'transform': 'translateY(0)'
          });
        }, 100);
      });

      $('#formFieldsContainer input, #formFieldsContainer select, #formFieldsContainer textarea').on('input change', function () {
        updateDocumentPreview();
      });
    }

    function showFormDetails(form) {
      const formFieldsContainer = $('#formFieldsContainer');
      formFieldsContainer.html('<div class="text-center py-5"><div class="a24-spinner"></div><p class="mt-3" style="color: #64748b; font-family: \'SF Pro Text\', \'Segoe UI\', -apple-system, BlinkMacSystemFont, Roboto, Oxygen, Ubuntu, sans-serif;">Initializing form request...</p></div>');

      if (form.templateData) {
        initializeFormWithData(form.templateData);
      } else {
        google.script.run
          .withSuccessHandler(function (response) {
            initializeFormWithData(response.templateData);
          })
          .withFailureHandler(function (error) {
            showAlert('Error initializing form: ' + error.message, 'danger');
            $('.row-loading').each(function () {
              $(this).removeClass('row-loading');
            });
          })
          .initializeFormRequest(form.templateId);
      }
    }

    $('#dynamicForm').on('submit', function (e) {
      e.preventDefault();
      registerTemplate();
    });

    // Set up the control number toggle functionality
    function setupControlNumberToggle() {
      $('#controlNumberToggle').on('change', function () {
        const includeControlNumber = $(this).is(':checked');
        $('#includeControlNumber').val(includeControlNumber.toString());

        // Always show the control number field, but update its display based on toggle state
        const controlNumberField = $('#formFieldsContainer').find('.control-number-field');
        if (controlNumberField.length > 0) {
          const controlNumberGroup = controlNumberField.closest('.mb-3');
          if (!includeControlNumber) {
            // If control number is disabled, add a note explaining it's for tracking only
            if (controlNumberGroup.find('.control-number-note').length === 0) {
              controlNumberGroup.append('<small class="text-muted control-number-note d-block mt-1"><i class="bi bi-info-circle me-1"></i>This control number will be used for tracking only and won\'t appear in the document.</small>');
            }
            controlNumberField.addClass('text-muted opacity-75');
          } else {
            // If control number is enabled, remove the note and restore normal appearance
            controlNumberGroup.find('.control-number-note').remove();
            controlNumberField.removeClass('text-muted opacity-75');
          }
        }
      });

      // Initial trigger to set the correct state
      $('#controlNumberToggle').trigger('change');
    }

    function registerTemplate() {
      if (isSubmitting) {
        console.log('Registration already in progress');
        return;
      }

      // Check if there are any personnel with levels
      const personnelWithLevels = window.personnelData?.names
        .map(name => {
          let level = '';
          if (window.personnelData.values) {
            const personnelEntry = window.personnelData.values.find(p => p[1] === name);
            if (personnelEntry && personnelEntry.length > 4) {
              level = personnelEntry[4] || '';
            }
          }
          return { name, level };
        })
        .filter(person => person.level);

      if (!personnelWithLevels || personnelWithLevels.length === 0) {
        showAlert('Cannot register: No personnel with level assignments available', 'danger');
        return;
      }

      isSubmitting = true;
      const templateName = $('#modalFormName').text();

      // Get the author toggle state
      const includeAuthor = $('#authorToggle').is(':checked');

      // Get the control number toggle state
      const includeControlNumber = $('#controlNumberToggle').is(':checked');

      // Always include the level order
      const levelOrder = getLevelOrder();

      if (!levelOrder) {
        showAlert('Please add at least one level to the level order', 'warning');
        isSubmitting = false;
        return;
      }

      console.log('Include Author:', includeAuthor);
      console.log('Include Control Number:', includeControlNumber);
      console.log('Level Order:', levelOrder);

      // Collect form field values to create the document
      const formValues = [];

      // Log all form fields that are available
      console.log('Form fields:', $('#dynamicForm').find('input:not([readonly]), select, textarea').map(function () {
        return {
          id: $(this).attr('id'),
          name: $(this).attr('name'),
          type: $(this).attr('type') || $(this).prop('tagName'),
          value: $(this).val()
        };
      }).get());

      const inputs = $('#dynamicForm').find('input:not([readonly]):not(.control-number-field), select, textarea');

      inputs.each(function () {
        if ($(this).attr('type') === 'submit' || $(this).attr('type') === 'button') return;

        const fieldName = $(this).attr('name');

        // Skip approval workflow fields
        if (!fieldName || fieldName === 'levelOrderArray' || fieldName === 'includeAuthor' ||
          fieldName === 'includeControlNumber' || fieldName.startsWith('personnel_')) {
          return;
        }

        let fieldValue;

        if ($(this).is('select')) {
          fieldValue = $(this).find('option:selected').val() || '';
        } else if ($(this).attr('type') === 'checkbox') {
          fieldValue = $(this).is(':checked');
        } else if ($(this).attr('type') === 'date') {
          // Handle date inputs directly
          fieldValue = $(this).val();
        } else {
          fieldValue = $(this).val();
        }

        formValues.push({ name: fieldName, value: fieldValue });
      });

      // Log the final form values
      console.log('Form values to be submitted with template:', formValues);

      const submitBtn = $('#dynamicForm').find('button[type="submit"]');
      const originalBtnText = submitBtn.html();
      submitBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Registering...');
      submitBtn.prop('disabled', true);

      google.script.run
        .withSuccessHandler(function (response) {
          console.log('Template registration response:', response);

          if (response.document && response.document.status === 'success') {
            showAlert('Template registered and document created successfully!', 'success');

            // Open the created document if available
            if (response.document.documentUrl) {
              setTimeout(() => {
                window.open(response.document.documentUrl, '_blank');
              }, 500);
            }
          } else if (response.document && response.document.status === 'error') {
            showAlert('Template registered but document creation failed: ' + response.document.message, 'warning');
          } else {
            showAlert('Template registered successfully!', 'success');
          }

          const modal = bootstrap.Modal.getInstance($('#formDetailsModal')[0]);
          if (modal) modal.hide();
          currentControlNumber = null;
          currentTemplateData = null;
          submitBtn.html(originalBtnText);
          submitBtn.prop('disabled', false);
          isSubmitting = false;
        })
        .withFailureHandler(function (error) {
          showAlert('Error registering template: ' + (error.message || 'Unknown error occurred'), 'danger');
          submitBtn.html(originalBtnText);
          submitBtn.prop('disabled', false);
          isSubmitting = false;
        })
        .registerTemplate(templateName, levelOrder, includeAuthor, formValues, includeControlNumber);
    }

    function submitFormData() {
      if (isSubmitting) {
        console.log('Submission already in progress');
        return;
      }

      isSubmitting = true;
      const formValues = [];
      const templateName = $('#modalFormName').text();

      // Get the control number toggle state
      const includeControlNumber = $('#controlNumberToggle').is(':checked');
      console.log('Include Control Number:', includeControlNumber);

      // Log all form fields that are available
      console.log('Form fields:', $('#dynamicForm').find('input:not([readonly]), select, textarea').map(function () {
        return {
          id: $(this).attr('id'),
          name: $(this).attr('name'),
          type: $(this).attr('type') || $(this).prop('tagName'),
          value: $(this).val()
        };
      }).get());

      const inputs = $('#dynamicForm').find('input:not([readonly]):not(.control-number-field), select, textarea');

      inputs.each(function () {
        if ($(this).attr('type') === 'submit' || $(this).attr('type') === 'button') return;

        const fieldName = $(this).attr('name');

        // Skip form management fields
        if (!fieldName || fieldName === 'levelOrderArray' || fieldName === 'includeAuthor' ||
          fieldName === 'includeControlNumber' || fieldName.startsWith('personnel_')) {
          return;
        }

        let fieldValue;

        if ($(this).is('select')) {
          fieldValue = $(this).find('option:selected').val() || '';
        } else if ($(this).attr('type') === 'checkbox') {
          fieldValue = $(this).is(':checked');
        } else if ($(this).attr('type') === 'date') {
          // Handle date inputs directly
          fieldValue = $(this).val();
        } else {
          fieldValue = $(this).val();
        }

        formValues.push({ name: fieldName, value: fieldValue });
      });

      // Log the final form values
      console.log('Form values to be submitted:', formValues);

      const submitBtn = $('#dynamicForm').find('button[type="submit"]');
      const originalBtnText = submitBtn.html();
      submitBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Submitting...');
      submitBtn.prop('disabled', true);

      google.script.run
        .withSuccessHandler(function (response) {
          google.script.run
            .withSuccessHandler(function (docResponse) {
              showAlert('Form submitted successfully!' + (response.controlNumber ? ' Control Number: ' + response.controlNumber : ''), 'success');
              const modal = bootstrap.Modal.getInstance($('#formDetailsModal')[0]);
              if (modal) modal.hide();
              currentControlNumber = null;
              currentTemplateData = null;
              submitBtn.html(originalBtnText);
              submitBtn.prop('disabled', false);
              isSubmitting = false;

              if (docResponse) {
                window.open(docResponse, '_blank');
              }
            })
            .withFailureHandler(function (docError) {
              showAlert('Document creation failed: ' + docError.message, 'danger');
              submitBtn.html(originalBtnText);
              submitBtn.prop('disabled', false);
              isSubmitting = false;
            })
            .createDoc({
              templateId: templateName,
              controlNumber: response.controlNumber,
              ...formValues
            });
        })
        .withFailureHandler(function (error) {
          showAlert('Error submitting form: ' + (error.message || 'Unknown error occurred'), 'danger');
          submitBtn.html(originalBtnText);
          submitBtn.prop('disabled', false);
          isSubmitting = false;
        })
        .submitFormData(templateName, includeControlNumber);
    }

    function updateDocumentPreview() {
      console.log('Document preview updated');
    }

    // ===========================================================================
    // Search Functions
    // ===========================================================================
    $('#searchInput').on('input', function () {
      const searchTerm = $(this).val().toLowerCase().trim();

      if (searchTerm.length === 0) {
        $('#searchResults').html(`
        <div class="text-center py-5">
          <div class="d-flex justify-content-center align-items-center mb-4">
            <i class="bi bi-search text-muted opacity-50" style="font-size: 4rem;"></i>
          </div>
          <p class="text-muted fs-5">
            Enter a search term above to find forms
          </p>
        </div>
      `);
        return;
      }

      if (!window.formData) return;

      const filteredData = window.formData.filter(item =>
        item.formName.toLowerCase().includes(searchTerm)
      );

      displaySearchResults(filteredData, searchTerm);
    });

    function displaySearchResults(results, searchTerm) {
      const searchResults = $('#searchResults');

      if (results.length === 0) {
        searchResults.html(`
        <div class="text-center py-5">
          <div class="d-flex justify-content-center align-items-center mb-4">
            <i class="bi bi-search text-muted" style="font-size: 32px;"></i>
          </div>
          <h5 class="fw-bold text-dark mb-3">No Results Found</h5>
          <p class="text-muted mx-auto" style="max-width: 400px;">
            No forms match your search for "${searchTerm}". Try using different keywords.
          </p>
        </div>
      `);
        return;
      }

      let resultsHTML = `
      <div class="mb-4">
        <p class="text-muted">
          ${results.length} result${results.length === 1 ? '' : 's'} found
        </p>
      </div>
      <div class="row">
    `;

      results.forEach(item => {
        resultsHTML += `
        <div class="col-12 mb-3">
          <div class="card shadow-sm h-100" data-form-id="${item.templateId}">
            <div class="card-body d-flex align-items-center">
              <div class="bg-light rounded-3 p-3 me-3">
                <i class="bi bi-file-earmark-text text-primary" style="font-size: 1.25rem;"></i>
              </div>
              <div>
                <h5 class="card-title fw-bold mb-1">${item.formName}</h5>
                <p class="card-text text-muted small mb-0">CHED Form Template</p>
              </div>
            </div>
          </div>
        </div>
      `;
      });

      resultsHTML += `</div>`;
      searchResults.html(resultsHTML);

      $('.card[data-form-id]').on('click', function () {
        const formId = $(this).data('form-id');
        const form = window.formData.find(item => item.templateId === formId);

        if (form) {
          showFormDetails.call(this, form);
        }
      });
    }

    // ===========================================================================
    // Form Fields
    // ===========================================================================
    function initializeFormWithData(templateData) {
      currentControlNumber = "TEMP-" + Math.random().toString(36).substr(2, 8).toUpperCase();
      currentTemplateData = templateData;

      $('#modalFormName').text(templateData["File Name"] || "Untitled Form");
      const fileId = templateData["File ID"];

      if (fileId) {
        const docUrl = 'https://docs.google.com/document/d/' + fileId + '/edit';
        const urlElement = $('#modalFormUrl');
        urlElement.attr('href', docUrl);
        urlElement.text('View template document');
      }

      if (templateData["Fields"]) {
        createDynamicFields(templateData["Fields"], $('#formFieldsContainer')[0], currentControlNumber);
      } else {
        $('#formFieldsContainer').html('<div class="alert alert-warning">No fields defined for this template</div>');
      }

      const modal = new bootstrap.Modal($('#formDetailsModal')[0]);
      modal.show();
    }

    function loadFormData() {
      $('#templatesTableBody').html(`
      <tr>
        <td colspan="7" class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
          <p class="text-muted mt-3">Loading templates...</p>
        </td>
      </tr>
    `);

      google.script.run
        .withSuccessHandler(function (templates) {
          const templateArray = Object.keys(templates).map(templateName => {
            return {
              formName: templateName,
              templateId: templateName,
              templateData: templates[templateName]
            };
          });

          populateCards(templateArray);
        })
        .withFailureHandler(function (error) {
          $('#templatesTableBody').html(`
          <tr>
            <td colspan="7" class="text-center py-4">
              <div class="d-flex justify-content-center align-items-center mb-3">
                <i class="bi bi-exclamation-triangle-fill text-danger fs-4"></i>
              </div>
              <p class="text-danger">Error loading templates: ${error.message || 'Unknown error'}</p>
            </td>
          </tr>
        `);
        })
        .getAllTemplates();
    }

    function handleError(error) {
      $('#cardsContainer').html('<div class="text-center py-5 w-100"><div class="d-flex justify-content-center align-items-center mb-3"><i class="bi bi-exclamation-triangle-fill text-danger fs-4"></i></div><p class="text-danger">Error loading forms: ' + (error.message || 'Unknown error') + '</p></div>');
    }

    function populateCards(data) {
      const templatesTableBody = $('#templatesTableBody');
      const emptyState = $('#emptyState');

      if (!data || data.length === 0) {
        templatesTableBody.html('<tr><td colspan="7" class="text-center py-3"><div style="min-width: 300px; font-size: 12px; color: #64748b;">No templates found</div></td></tr>');
        emptyState.removeClass('d-none');
        $('#formCount').text('0 forms');
        return;
      }

      emptyState.addClass('d-none');
      templatesTableBody.html('');
      $('#formCount').text(data.length + (data.length === 1 ? ' form' : ' forms'));

      const isCurrentMobile = window.innerWidth < isMobile;
      const isTablet = window.innerWidth >= isMobile && window.innerWidth < 992;

      function formatField(value) {
        if (!value) return '-';

        if (isCurrentMobile && value.length > 40) {
          return value.substring(0, 37) + '...';
        }

        if (isTablet && value.length > 30) {
          return value.substring(0, 27) + '...';
        }

        return value;
      }

      $.each(data, function (index, item) {
        if (!item.formName) return;

        const row = $('<tr>').css({
          'opacity': '0',
          'transform': 'translateY(10px)',
          'transition': 'all 0.3s ease',
          'transition-delay': (index * 0.05) + 's',
          'cursor': 'pointer'
        });

        const templateData = item.templateData || {};
        const indexCell = $('<td>').addClass('cell-index').text(index + 1);
        const nameCell = $('<td>').addClass('cell-name').html(`<p style="margin: 0; font-weight: 500; color: #1e293b;">${item.formName}</p>`);
        const fieldsCell = $('<td>').addClass('cell-fields').text(formatField(templateData["Fields"]));
        const fieldsForFilenameCell = $('<td>').addClass('cell-filename-fields d-none d-md-table-cell').text(formatField(templateData["Fields for Filename"]));
        const fileIdCell = $('<td>').addClass('cell-fileid d-none d-lg-table-cell').text(formatField(templateData["File ID"]));
        const emailCell = $('<td>').addClass('cell-email d-none d-md-table-cell').text(formatField(templateData["Email"]));
        const isPrivateCell = $('<td>').addClass('cell-private').html(templateData["isPrivate"] ? '<span class="status-badge yes">Yes</span>' : '<span class="status-badge no">No</span>');

        row.append(indexCell, nameCell, fieldsCell, fieldsForFilenameCell, fileIdCell, emailCell, isPrivateCell);
        templatesTableBody.append(row);

        setTimeout(() => {
          row.css({
            'opacity': '1',
            'transform': 'translateY(0)'
          });
        }, 50);

        row.on('click', function () {
          $(this).addClass('bg-light');
          const originalContent = nameCell.html();
          nameCell.html(`
          <div class="d-flex align-items-center">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true" 
                  style="width: 1rem; height: 1rem; border-width: 0.15em;"></span>
            <span>Loading...</span>
          </div>
        `);

          showFormDetails.call(this, item);

          setTimeout(() => {
            nameCell.html(originalContent);
            $(this).removeClass('bg-light');
          }, 2000);
        });
      });

      window.formData = data;

      if (!window.hasTemplateResizeListener) {
        window.addEventListener('resize', function () {
          const newIsCurrentMobile = window.innerWidth < isMobile;
          const newIsTablet = window.innerWidth >= isMobile && window.innerWidth < 992;

          if (newIsCurrentMobile !== isCurrentMobile || newIsTablet !== isTablet) {
            populateCards(window.formData);
          }
        });
        window.hasTemplateResizeListener = true;
      }
    }

    // ===========================================================================
    // Submissions Page Functions
    // ===========================================================================
    function loadSubmissionsData() {
      $('#submissionsTableBody').html(`
      <tr>
        <td colspan="5" class="text-center py-4">
          <div class="spinner-border text-primary" role="status"></div>
        </td>
      </tr>
    `);

      $('#submissionsEmptyState').hide();

      google.script.run
        .withSuccessHandler(function (response) {
          if (response.status === "success") {
            displaySubmissionsData(response.submissions);
          } else {
            showAlert('Error loading submissions: ' + response.message, 'danger');
            $('#submissionsTableBody').html(`
            <tr>
              <td colspan="6" class="text-center py-4 text-danger">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Failed to load submissions
              </td>
            </tr>
          `);
          }
        })
        .withFailureHandler(function (error) {
          showAlert('Error loading submissions: ' + (error.message || 'Unknown error occurred'), 'danger');
          $('#submissionsTableBody').html(`
          <tr>
            <td colspan="6" class="text-center py-4 text-danger">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              Failed to load submissions
            </td>
          </tr>
        `);
        })
        .getAllSubmissions();
    }

    function displaySubmissionsData(submissions) {
      if (!submissions || submissions.length === 0) {
        $('#submissionsTable').hide();
        $('#submissionsEmptyState').show();
        return;
      }

      $('#submissionsTable').show();
      $('#submissionsEmptyState').hide();

      const tableBody = $('#submissionsTableBody');
      tableBody.empty();

      const isCurrentMobile = window.innerWidth < isMobile;

      submissions.forEach((submission, index) => {
        const row = $('<tr>').css({
          'opacity': '0',
          'transform': 'translateY(10px)',
          'transition': 'all 0.3s ease',
          'transition-delay': (index * 0.05) + 's'
        });

        const truncatedFileId = isCurrentMobile ?
          submission.fileId :
          (submission.fileId.length > 25
            ? submission.fileId.substring(0, 12) + '...' + submission.fileId.substring(submission.fileId.length - 12)
            : submission.fileId);

        const cells = createSubmissionCells(submission, index + 1, truncatedFileId);
        Object.values(cells).forEach(cell => row.append(cell));
        tableBody.append(row);

        setTimeout(() => {
          row.css({
            'opacity': '1',
            'transform': 'translateY(0)'
          });
        }, 50);
      });

      initializeRefreshButtons();
      setupSubmissionsResizeListener(isCurrentMobile);
    }

    function createSubmissionCells(submission, index, truncatedFileId) {
      const indexCell = $('<td>').html(`<span style="color: #5f6368;">${index}</span>`);
      const fileNameCell = $('<td>').html(`
      <div class="d-flex align-items-center">
        <i class="bi bi-file-text me-2" style="color: #34a853;"></i>
        <span class="text-truncate" style="color: #202124; font-weight: 500;" title="${submission.fileName || 'No file name'}">${submission.fileName || '<span style="color: #5f6368; font-style: italic;">No file name</span>'}</span>
      </div>
    `);
      const fileIdCell = $('<td>').html(`
      <div class="d-flex align-items-center">
        <i class="bi bi-file-earmark-text me-2" style="color: #1a73e8;"></i>
        <span class="file-id" title="${submission.fileId}" data-id="${submission.fileId}" style="color: #5f6368; font-family: 'Google Sans Mono', 'Roboto Mono', monospace;">${truncatedFileId}</span>
      </div>
    `);
      const emailCell = $('<td>').html(createEmailCellContent(submission));
      const statusCell = $('<td>').html(getStatusBadge(submission.status || 'Pending'));
      const actionsCell = $('<td>').html(`
      <div class="d-flex justify-content-end">
        <a href="${submission.documentUrl}" target="_blank" class="google-action-btn primary me-1" title="View Document">
          <i class="bi bi-eye"></i>
        </a>
      </div>
    `);

      return { indexCell, fileNameCell, fileIdCell, emailCell, statusCell, actionsCell };
    }

    function createEmailCellContent(submission) {
      let emailHtml = '<div class="d-flex flex-column">';

      if (submission.initialPersonality) {
        emailHtml += `<div class="d-flex align-items-center small mb-1">
          <i class="bi bi-person-badge me-2" style="color: #1a73e8;"></i>
          <span style="color: #5f6368;">Initial:</span> <span class="ms-1" style="color: #202124;">${submission.initialPersonality}</span>
        </div>`;
      }

      if (submission.signaturePersonality) {
        emailHtml += `<div class="d-flex align-items-center small">
          <i class="bi bi-pen me-2" style="color: #1a73e8;"></i>
          <span style="color: #5f6368;">Signature:</span> <span class="ms-1" style="color: #202124;">${submission.signaturePersonality}</span>
        </div>`;
      }

      if (!submission.email && !submission.initialPersonality && !submission.signaturePersonality) {
        emailHtml += '<span style="color: #5f6368; font-style: italic;">No recipients</span>';
      }

      emailHtml += '</div>';
      return emailHtml;
    }

    function initializeRefreshButtons() {
      $('.refresh-status-btn').on('click', function () {
        const btn = $(this);
        const fileId = btn.data('fileid');
        const originalHtml = btn.html();
        btn.html('<div class="google-spinner" style="width:16px;height:16px;border-width:2px;"></div>');
        btn.prop('disabled', true);

        google.script.run
          .withSuccessHandler(function (result) {
            if (result === true) {
              loadSubmissionsData();
              showAlert('Status updated successfully', 'success');
            } else {
              showAlert('Failed to update status', 'danger');
              btn.html(originalHtml);
              btn.prop('disabled', false);
            }
          })
          .withFailureHandler(function (error) {
            showAlert('Error updating status: ' + (error.message || 'Unknown error occurred'), 'danger');
            btn.html(originalHtml);
            btn.prop('disabled', false);
          })
          .updateSubmissionStatus(fileId);
      });
    }

    function setupSubmissionsResizeListener(isCurrentMobile) {
      if (!window.hasResizeListener) {
        window.addEventListener('resize', function () {
          const newIsCurrentMobile = window.innerWidth < isMobile;
          if (newIsCurrentMobile !== isCurrentMobile) {
            loadSubmissionsData();
          }
        });
        window.hasResizeListener = true;
      }
    }

    function getStatusBadge(status) {
      const statusLower = status.toLowerCase();
      let badgeClass = '';
      let iconClass = '';

      if (statusLower.includes('stamped') || statusLower.includes('completed') ||
        statusLower.includes('approved') || statusLower.includes('signed')) {
        badgeClass = 'completed';
        iconClass = 'bi-check-circle-fill';
      } else if (statusLower.includes('requesting signature')) {
        badgeClass = 'signature';
        iconClass = 'bi-pen-fill';
      } else if (statusLower.includes('requesting') || statusLower.includes('in progress')) {
        badgeClass = 'processing';
        iconClass = 'bi-arrow-repeat';
      } else if (statusLower.includes('pending')) {
        badgeClass = 'pending';
        iconClass = 'bi-clock-fill';
      } else if (statusLower.includes('rejected') || statusLower.includes('failed')) {
        badgeClass = 'failed';
        iconClass = 'bi-exclamation-triangle-fill';
      }

      return `<span class="status-badge ${badgeClass}"><i class="bi ${iconClass} me-1"></i>${status}</span>`;
    }

    // ===========================================================================
    // Dynamic Form Fields
    // ===========================================================================
    function createDynamicFields(fieldsString, container, controlNumber) {
      $(container).empty();

      // Add Control Number field - always shown, but with a note if toggle is off
      const controlNumberGroup = $('<div>').addClass('mb-3');
      const controlLabel = $('<label>').addClass('form-label').text('Control No');
      const controlInput = $('<input>').attr({
        type: 'text',
        class: 'form-control bg-light control-number-field',
        value: controlNumber,
        readonly: true
      }).css({
        'color': '#6c757d',
        'font-weight': '500'
      });
      controlNumberGroup.append(controlLabel, controlInput);

      // Add a note if control number toggle is off
      if ($('#controlNumberToggle').length > 0 && !$('#controlNumberToggle').is(':checked')) {
        controlInput.addClass('text-muted opacity-75');
        controlNumberGroup.append('<small class="text-muted control-number-note d-block mt-1"><i class="bi bi-info-circle me-1"></i>This control number will be used for tracking only and won\'t appear in the document.</small>');
      }

      $(container).append(controlNumberGroup);

      const fieldsArray = fieldsString.split(';').map(f => f.trim()).filter(f => f && !f.startsWith('CONTROL NO'));

      fieldsArray.forEach(field => {
        const separator = field.includes(':') ? ':' : ';';
        const [name, type] = field.split(separator).map(f => f.trim());
        let fieldId;
        if (name.toUpperCase() === 'TARGET PERSON') {
          fieldId = 'target-person';
        } else {
          fieldId = name.toLowerCase().replace(/\s+/g, '-');
        }

        const fieldGroup = $('<div>').addClass('mb-3');
        const label = $('<label>').addClass('form-label').attr('for', fieldId).text(name);

        if (type && type.startsWith('SELECT=')) {
          createSelectField(fieldGroup, name, fieldId, type, label);
        } else if (type && type.toUpperCase() === 'PERSONALITY') {
          createPersonalityField(fieldGroup, name, fieldId, label);
        } else {
          const normalizedType = type ? type.toUpperCase().trim() : 'TEXT';

          if (normalizedType === 'DATE' || normalizedType === 'FULL DATE') {
            createDateField(fieldGroup, name, fieldId, normalizedType, label);
          } else if (normalizedType === 'TIME') {
            createTimeField(fieldGroup, name, fieldId, label);
          } else {
            createStandardField(fieldGroup, name, fieldId, normalizedType, label);
          }
        }

        $(container).append(fieldGroup);
      });
    }

    function createSelectField(fieldGroup, name, fieldId, type, label) {
      const input = $('<select>').addClass('form-select').attr({
        id: fieldId,
        name: name
      });

      $('<option>').attr({
        value: '',
        selected: true,
        disabled: true
      }).text('-- Select an option --').appendTo(input);

      type.split('=')[1].split('|').forEach(option => {
        $('<option>').attr('value', option).text(option).appendTo(input);
      });

      fieldGroup.append(label, input);
    }

    function createPersonalityField(fieldGroup, name, fieldId, label) {
      const input = $('<select>').addClass('form-select').attr({
        id: fieldId,
        name: name
      });

      $('<option>').attr({
        value: '',
        selected: true,
        disabled: true
      }).text('-- Select a personality --').appendTo(input);

      // Populate with available personalities
      if (window.personnelData && window.personnelData.names && window.personnelData.values) {
        window.personnelData.values.forEach(personnelEntry => {
          if (personnelEntry && personnelEntry.length > 1) {
            const email = personnelEntry[0] || '';
            const name = personnelEntry[1] || '';
            if (email && name) {
              $('<option>').attr('value', email).text(name).appendTo(input);
            }
          }
        });
      } else {
        // If personnel data isn't loaded yet, load it
        loadPersonnelData().then(data => {
          input.empty();
          $('<option>').attr({
            value: '',
            selected: true,
            disabled: true
          }).text('-- Select a personality --').appendTo(input);

          if (data.values) {
            data.values.forEach(personnelEntry => {
              if (personnelEntry && personnelEntry.length > 1) {
                const email = personnelEntry[0] || '';
                const name = personnelEntry[1] || '';
                if (email && name) {
                  $('<option>').attr('value', email).text(name).appendTo(input);
                }
              }
            });
          }
        }).catch(err => {
          console.error('Failed to load personalities for field:', err);
        });
      }

      fieldGroup.append(label, input);
    }

    function createDateField(fieldGroup, name, fieldId, normalizedType, label) {
      if (normalizedType === 'FULL DATE') {
        const dateTimeGroup = $('<div>').addClass('datetime-group');

        const dateLabel = $('<label>').addClass('form-label small').text('Date');
        const dateInput = $('<input>').addClass('form-control datepicker').attr({
          id: fieldId,
          name: name,
          type: 'date'
        }).css('max-width', '200px');

        dateTimeGroup.append(
          $('<div>').append(label),
          $('<div>').append(dateLabel, dateInput)
        );

        fieldGroup.append(dateTimeGroup);

        if (dateInput[0].type !== 'date') {
          dateInput.attr('type', 'text')
            .addClass('date-fallback')
            .attr('placeholder', 'YYYY-MM-DD')
            .datepicker({
              dateFormat: 'yy-mm-dd',
              changeMonth: true,
              changeYear: true
            });
        }
      } else {
        const inputWrapper = $('<div>').css('max-width', '200px');

        const input = $('<input>').addClass('form-control datepicker').attr({
          id: fieldId,
          name: name,
          type: 'date'
        });

        if (input[0].type !== 'date') {
          input.attr('type', 'text')
            .addClass('date-fallback')
            .attr('placeholder', 'YYYY-MM-DD')
            .datepicker({
              dateFormat: 'yy-mm-dd',
              changeMonth: true,
              changeYear: true
            });
        }

        inputWrapper.append(input);
        fieldGroup.append(label, inputWrapper);
      }
    }

    function createTimeField(fieldGroup, name, fieldId, label) {
      const inputWrapper = $('<div>').css('max-width', '150px');

      const input = $('<input>').addClass('form-control').attr({
        id: fieldId,
        name: name,
        type: 'time'
      });

      if (input[0].type !== 'time') {
        input.attr('type', 'text')
          .addClass('time-fallback')
          .attr('placeholder', 'HH:MM');
        if ($.fn.timepicker) {
          input.timepicker({
            timeFormat: 'H:i',
            step: 5
          });
        }
      }

      inputWrapper.append(input);
      fieldGroup.append(label, inputWrapper);
    }

    function addDateTimeFallbacks(dateInput, timeInput) {
      if (dateInput[0].type !== 'date') {
        dateInput.attr('type', 'text')
          .addClass('date-fallback')
          .attr('placeholder', 'YYYY-MM-DD')
          .datepicker({
            dateFormat: 'yy-mm-dd',
            changeMonth: true,
            changeYear: true
          });
      }

      if (timeInput[0].type !== 'time') {
        timeInput.attr('type', 'text')
          .addClass('time-fallback')
          .attr('placeholder', 'HH:MM');
        if ($.fn.timepicker) {
          timeInput.timepicker({
            timeFormat: 'H:i',
            step: 5
          });
        }
      }
    }

    function createStandardField(fieldGroup, name, fieldId, normalizedType, label) {
      let input;

      switch (normalizedType) {
        case 'NUMBER':
          input = $('<input>').addClass('form-control').attr({
            id: fieldId,
            name: name,
            type: 'number'
          });
          break;
        case 'TEXTAREA':
          input = $('<textarea>').addClass('form-control').attr({
            id: fieldId,
            name: name,
            rows: 3
          });
          break;
        case 'EMAIL':
          input = $('<input>').addClass('form-control').attr({
            id: fieldId,
            name: name,
            type: 'email'
          });
          break;
        case 'PASSWORD':
          input = $('<input>').addClass('form-control').attr({
            id: fieldId,
            name: name,
            type: 'password'
          });
          break;
        case 'TIME':
          const timeWrapper = $('<div>').css('max-width', '150px');
          input = $('<input>').addClass('form-control').attr({
            id: fieldId,
            name: name,
            type: 'time'
          });
          timeWrapper.append(input);
          fieldGroup.append(label, timeWrapper);
          return;
        case 'CHECKBOX':
          const checkDiv = $('<div>').addClass('form-check');
          input = $('<input>').addClass('form-check-input').attr({
            id: fieldId,
            name: name,
            type: 'checkbox'
          });
          const checkLabel = $('<label>').addClass('form-check-label').attr('for', fieldId).text(name);
          checkDiv.append(input, checkLabel);
          fieldGroup.append(checkDiv);
          return;
        default:
          input = $('<input>').addClass('form-control').attr({
            id: fieldId,
            name: name,
            type: 'text'
          });
      }

      fieldGroup.append(label, input);
    }

    // ===========================================================================
    // Alert/Notification Functions
    // ===========================================================================
    function showAlert(message, type) {
      $('.toast-container').remove();

      if ($('.toast-container').length === 0) {
        $('body').append('<div class="toast-container position-fixed top-0 start-50 translate-middle-x mt-3"></div>');
      }
      const alertClasses = {
        success: 'text-bg-success',
        danger: 'text-bg-danger',
        info: 'text-bg-primary'
      };

      const toastClass = alertClasses[type] || alertClasses.info;

      const toast = `
      <div class="toast align-items-center ${toastClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    `;

      $('.toast-container').html(toast);
      const toastElement = new bootstrap.Toast($('.toast')[0], { delay: 4000 });
      toastElement.show();
    }

    // ===========================================================================
    // Filter Functions
    // ===========================================================================
    function filterSubmissionsTable() {
      const filterText = $('#submissionsFilter').val().toLowerCase();
      const statusFilter = $('.status-filter.active').data('status') || 'all';

      $('#submissionsTableBody tr').each(function () {
        const $row = $(this);

        if ($row.find('td[colspan]').length > 0) return;

        const fileName = $row.find('td:nth-child(2)').text().toLowerCase();
        const fileId = $row.find('[data-id]').data('id')?.toString().toLowerCase() || '';
        const email = $row.find('td:nth-child(4)').text().toLowerCase();
        const status = $row.find('td:nth-child(5)').text().toLowerCase();

        const textMatch = !filterText ||
          fileName.includes(filterText) ||
          fileId.includes(filterText) ||
          email.includes(filterText) ||
          status.includes(filterText);

        let statusMatch = true;
        if (statusFilter !== 'all') {
          if (statusFilter === 'completed') {
            statusMatch = status.includes('stamped') ||
              status.includes('signed') ||
              status.includes('completed') ||
              status.includes('approved');
          } else if (statusFilter === 'pending') {
            statusMatch = status.includes('pending') ||
              status.includes('request');
          }
        }

        if (textMatch && statusMatch) {
          $row.show();
        } else {
          $row.hide();
        }
      });

      showNoResultsRowIfNeeded();
    }

    function showNoResultsRowIfNeeded() {
      const visibleRows = $('#submissionsTableBody tr:visible').length;
      if (visibleRows === 0) {
        if ($('#noFilterResultsRow').length === 0) {
          $('#submissionsTableBody').append(`
          <tr id="noFilterResultsRow">
            <td colspan="6" class="text-center py-4">
              <i class="bi bi-search me-2" style="color: #80868b;"></i>
              <span style="color: #5f6368;">No submissions match your filter criteria</span>
            </td>
          </tr>
        `);
        } else {
          $('#noFilterResultsRow').show();
        }
      } else {
        $('#noFilterResultsRow').hide();
      }
    }

    $('.status-filter').on('click', function () {
      $('.status-filter').removeClass('active material-chip-active google-chip-selected');
      $(this).addClass('active google-chip-selected');
      filterSubmissionsTable();
    });

    $('#submissionsFilter').on('input', function () {
      filterSubmissionsTable();
    });

    $('#refreshSubmissionsBtn').on('click', function () {
      const btn = $(this);
      const originalHtml = btn.html();

      btn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...');
      btn.prop('disabled', true);

      google.script.run
        .withSuccessHandler(function (refreshResult) {
          google.script.run
            .withSuccessHandler(function (response) {
              btn.html(originalHtml);
              btn.prop('disabled', false);

              if (response.status === "success") {
                displaySubmissionsData(response.submissions);
                showAlert('Submissions refreshed successfully', 'success');
              } else {
                showAlert('Error refreshing submissions: ' + response.message, 'danger');
              }
            })
            .withFailureHandler(function (error) {
              btn.html(originalHtml);
              btn.prop('disabled', false);
              showAlert('Error refreshing submissions: ' + (error.message || 'Unknown error occurred'), 'danger');
            })
            .getAllSubmissions();
        })
        .withFailureHandler(function (error) {
          btn.html(originalHtml);
          btn.prop('disabled', false);
          showAlert('Error refreshing statuses: ' + (error.message || 'Unknown error occurred'), 'danger');
        })
        .refreshAllStatuses();
    });

    // ===========================================================================
    // Responsive Layout
    // ===========================================================================
    $(window).resize(function () {
      $('#submissionsFilter').attr('placeholder', window.innerWidth < isMobile ? 'Filter...' : 'Filter by email or status...');

      if (window.innerWidth < isMobile) {
        $('.status-filter').addClass('w-100');
      } else {
        $('.status-filter').removeClass('w-100');
      }

      if (window.innerWidth < isMobile) {
        $('.sortable').each(function () {
          const dir = $(this).data('direction') || 'asc';
          const column = $(this).data('sort');

          if (column === 'formName') {
            $(this).html(
              'Name ' + (dir === 'asc' ? '(A-Z)' : '(Z-A)') +
              ' <i class="bi ' + (dir === 'asc' ? 'bi-sort-alpha-down' : 'bi-sort-alpha-up') + ' ms-1 small"></i>'
            );
          }
        });
      } else {
        $('.sortable[data-sort="formName"]').html(
          'Name <i class="bi bi-arrow-down-up ms-1 small"></i>'
        );
      }
    });

    $('#submissionsFilter').attr('placeholder', window.innerWidth < isMobile ? 'Filter...' : 'Filter by email or status...');

    if (window.innerWidth < isMobile) {
      $('.status-filter').addClass('w-100');
    }

    // Set up the author toggle functionality
    function setupAuthorToggle() {
      // Update the author step to only show 'Author' without email
      $('#authorToggle').on('change', function () {
        const isChecked = $(this).is(':checked');
        $('#includeAuthor').val(isChecked.toString());

        // Show or hide the author step
        if (isChecked) {
          $('#authorStep').show();
        } else {
          $('#authorStep').hide();
        }

        // Reorder all steps
        reorderApprovalSteps();
      });

      // Trigger change to initialize state
      $('#authorToggle').trigger('change');
    }
  });
</script>